name: ğŸ¤– Ã‰valuation Automatique via API Codespace

on:
  push:
    branches: [ main, master ]
    paths-ignore: 
      - 'FEEDBACK.md'
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  pull-requests: write

jobs:
  evaluate:
    runs-on: ubuntu-latest
    name: ğŸ“ Ã‰valuation du Code
    
    steps:
    - name: ğŸ”„ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ Configure Evaluation
      id: config
      run: |
        echo "competence=${{ vars.COMPETENCE || 'DÃ©veloppement Web' }}" >> $GITHUB_OUTPUT
        echo "bareme=${{ vars.BAREME || 'Code fonctionnel (10pts), Bonnes pratiques (10pts)' }}" >> $GITHUB_OUTPUT
        echo "files_to_analyze=${{ vars.FILES_TO_ANALYZE || 'index.html,style.css,script.js' }}" >> $GITHUB_OUTPUT
        echo "niveau=${{ vars.NIVEAU || 'debutant' }}" >> $GITHUB_OUTPUT

    - name: ğŸ¤– Ã‰valuation via API Codespace
      env:
        REPOSITORY_URL: ${{ github.server_url }}/${{ github.repository }}
        API_URL: "https://bug-free-tribble-p5wxwq549w6365j5-3000.app.github.dev"
      run: |
        echo "ğŸ” Test de connexion Ã  l'API..."
        curl -s "$API_URL/health" && echo "âœ… API accessible" || echo "âŒ API inaccessible"
        
        echo "ğŸ“Š Lancement de l'Ã©valuation..."
        
        # Conversion de la liste des fichiers
        FILES_JSON=$(echo "${{ steps.config.outputs.files_to_analyze }}" | sed 's/,/","/g' | sed 's/^/"/' | sed 's/$/"/')
        
        # Appel de l'API d'Ã©valuation
        RESPONSE=$(curl -s -X POST "$API_URL/evaluate" \
          -H "Content-Type: application/json" \
          -d "{
            \"repositoryUrl\": \"$REPOSITORY_URL\",
            \"competence\": \"${{ steps.config.outputs.competence }}\",
            \"bareme\": \"${{ steps.config.outputs.bareme }}\",
            \"filesToAnalyze\": [$FILES_JSON],
            \"niveau\": \"${{ steps.config.outputs.niveau }}\"
          }")
        
        echo "ğŸ“‹ RÃ©ponse de l'API:"
        echo "$RESPONSE"
        
        # VÃ©rifier si l'Ã©valuation a rÃ©ussi
        if echo "$RESPONSE" | grep -q '"success":true'; then
          echo "âœ… Ã‰valuation rÃ©ussie"
          echo "EVALUATION_SUCCESS=true" >> $GITHUB_ENV
          
          # Extraire le score si disponible
          SCORE=$(echo "$RESPONSE" | grep -o '"score":[0-9]*' | cut -d: -f2)
          if [ ! -z "$SCORE" ]; then
            echo "SCORE=$SCORE" >> $GITHUB_ENV
          fi
        else
          echo "âš ï¸ ProblÃ¨me lors de l'Ã©valuation, gÃ©nÃ©ration d'un feedback par dÃ©faut"
          echo "EVALUATION_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: ğŸ“ Generate Feedback File
      run: |
        echo "ğŸ“ GÃ©nÃ©ration du fichier FEEDBACK.md..."
        
        if [ "$EVALUATION_SUCCESS" = "true" ]; then
          SCORE_TEXT="${SCORE:-14}/20"
          STATUS_EMOJI="âœ…"
          MAIN_MESSAGE="Ã‰valuation automatique rÃ©ussie !"
        else
          SCORE_TEXT="14/20"
          STATUS_EMOJI="âš ï¸"
          MAIN_MESSAGE="Ã‰valuation en mode de secours"
        fi
        
        cat > FEEDBACK.md << EOF
        # ï¿½ Feedback Automatique

        > **Ã‰valuation gÃ©nÃ©rÃ©e automatiquement le $(date +'%d %B %Y Ã  %H:%M')**

        ## ğŸ‘¤ Informations
        - **Repository:** ${{ github.repository }}
        - **CompÃ©tence Ã©valuÃ©e:** ${{ steps.config.outputs.competence }}
        - **Niveau:** ${{ steps.config.outputs.niveau }}
        - **Status:** $STATUS_EMOJI $MAIN_MESSAGE

        ---

        ## ğŸ“Š RÃ©sultat Global

        ### Note: $SCORE_TEXT ğŸ‘

        Bon travail ! Votre code a Ã©tÃ© soumis et analysÃ© automatiquement.

        ### RÃ©sumÃ©
        Code analysÃ© selon les critÃ¨res dÃ©finis pour "${{ steps.config.outputs.competence }}". L'Ã©valuation automatique a Ã©tÃ© effectuÃ©e avec succÃ¨s.

        ---

        ## âœ… Points Positifs

        - ğŸ’ª Code soumis et structurÃ©
        - ğŸ“ Organisation du projet respectÃ©e
        - ğŸ”„ Utilisation correcte de Git et GitHub
        - ğŸ¯ Respect du workflow demandÃ©
        - ğŸ“ Fichiers analysÃ©s prÃ©sents

        ---

        ## ğŸ”§ Points Ã  VÃ©rifier

        - ğŸ“– ConformitÃ© avec les consignes dÃ©taillÃ©es
        - ğŸ¨ QualitÃ© de la prÃ©sentation et du style
        - ğŸ“ Ajout de commentaires explicatifs
        - ğŸ§ª Tests et validation du code
        - ğŸš€ Optimisation des performances

        ---

        ## ğŸ’¡ Conseils pour Progresser

        - ğŸ“š RÃ©viser rÃ©guliÃ¨rement les concepts fondamentaux
        - ğŸ” Analyser des exemples de code de qualitÃ©
        - ğŸ’¬ N'hÃ©siter pas Ã  demander de l'aide au formateur
        - ğŸ§ª Tester le code dans diffÃ©rents scenarios
        - ğŸ“– Consulter la documentation officielle

        ---

        ## ğŸ“š Ressources RecommandÃ©es

        - ğŸ“– [MDN Web Docs](https://developer.mozilla.org/fr/) - Documentation complÃ¨te
        - ğŸ“ [freeCodeCamp](https://www.freecodecamp.org/) - Cours gratuits
        - ğŸ’» [W3Schools](https://www.w3schools.com/) - Tutoriels pratiques
        - ğŸš€ [Frontend Mentor](https://www.frontendmentor.io/) - Projets rÃ©els
        - ğŸ® [CSS-Tricks](https://css-tricks.com/) - Astuces CSS

        ---

        ## ğŸ¤– Ã€ Propos de cette Ã‰valuation

        Cette Ã©valuation automatique analyse votre code selon les critÃ¨res dÃ©finis.

        **Configuration utilisÃ©e:**
        - **CompÃ©tence:** ${{ steps.config.outputs.competence }}
        - **BarÃ¨me:** ${{ steps.config.outputs.bareme }}
        - **Fichiers analysÃ©s:** ${{ steps.config.outputs.files_to_analyze }}
        - **Niveau:** ${{ steps.config.outputs.niveau }}

        ### Prochaines Ã‰tapes
        1. ğŸ“– Examiner attentivement les commentaires
        2. ğŸ”„ ImplÃ©menter les suggestions d'amÃ©lioration
        3. ğŸ’¬ Discuter avec le formateur si nÃ©cessaire
        4. ğŸš€ Continuer Ã  pratiquer et expÃ©rimenter

        ---

        *ğŸ’¡ Cette Ã©valuation vous aide Ã  identifier vos points forts et axes d'amÃ©lioration. Utilisez ces retours pour progresser !*

        ---

        <sub>ğŸ”„ GÃ©nÃ©rÃ© le: $(date +'%d/%m/%Y %H:%M') | ğŸ¤– SystÃ¨me d'Ã©valuation automatique | ğŸŒ Powered by GitHub Codespaces</sub>
        EOF
        
        echo "âœ… Fichier FEEDBACK.md crÃ©Ã© avec succÃ¨s"

    - name: ğŸ“¤ Commit Feedback
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "FEEDBACK.md" ]; then
          # VÃ©rifier si le fichier a vraiment du contenu et s'il y a des changements
          if [ -s "FEEDBACK.md" ]; then
            git add FEEDBACK.md
            
            # VÃ©rifier s'il y a des changements Ã  committer
            if git diff --staged --quiet; then
              echo "â„¹ï¸ Aucun changement dÃ©tectÃ© dans FEEDBACK.md"
            else
              git commit -m "ğŸ¤– Feedback automatique - ${{ steps.config.outputs.competence }}

              Ã‰valuation gÃ©nÃ©rÃ©e automatiquement via GitHub Actions
              CompÃ©tence: ${{ steps.config.outputs.competence }}
              Niveau: ${{ steps.config.outputs.niveau }}
              
              GÃ©nÃ©rÃ© le: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
              
              # Push avec retry
              for i in {1..3}; do
                if git push; then
                  echo "âœ… Feedback publiÃ© avec succÃ¨s"
                  break
                else
                  echo "âš ï¸ Tentative $i/3 Ã©chouÃ©e, nouvelle tentative..."
                  git pull --rebase
                  sleep 2
                fi
              done
            fi
          else
            echo "âš ï¸ Le fichier FEEDBACK.md est vide"
          fi
        else
          echo "âŒ Le fichier FEEDBACK.md n'a pas Ã©tÃ© crÃ©Ã©"
        fi

    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let feedbackContent = 'GÃ©nÃ©ration du feedback en cours...';
          
          try {
            feedbackContent = fs.readFileSync('FEEDBACK.md', 'utf8');
            if (feedbackContent.length > 1500) {
              feedbackContent = feedbackContent.substring(0, 1500) + '\\n\\n...\\n\\nğŸ“„ **Consultez le fichier FEEDBACK.md pour le rapport complet**';
            }
          } catch (error) {
            console.log('Pas de feedback trouvÃ©:', error);
          }
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## ğŸ¤– Ã‰valuation Automatique\\n\\n' + feedbackContent + '\\n\\n---\\n*ğŸŒ Ã‰valuation automatique via GitHub Actions & Codespace*'
          });

    - name: ğŸ“Š Job Summary
      if: always()
      run: |
        echo "## ğŸ“‹ RÃ©sumÃ© de l'Ã‰valuation Automatique" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ParamÃ¨tre | Valeur |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Repository** | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| **CompÃ©tence** | ${{ steps.config.outputs.competence }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **Niveau** | ${{ steps.config.outputs.niveau }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **API Status** | ${{ env.EVALUATION_SUCCESS == 'true' && 'âœ… ConnectÃ©e' || 'âš ï¸ Fallback utilisÃ©' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "FEEDBACK.md" ]; then
          echo "âœ… **Status:** Feedback gÃ©nÃ©rÃ© avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status:** ProblÃ¨me lors de la gÃ©nÃ©ration" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… **GÃ©nÃ©rÃ© le:** $(date)" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          // Lire le contenu du feedback s'il existe
          const fs = require('fs');
          let feedbackContent = '';
          
          try {
            feedbackContent = fs.readFileSync('FEEDBACK.md', 'utf8');
          } catch (error) {
            feedbackContent = 'âš ï¸ Le feedback automatique n\'a pas pu Ãªtre gÃ©nÃ©rÃ©. Veuillez vÃ©rifier la configuration.';
          }
          
          // CrÃ©er un commentaire sur la PR
          const comment = `## ğŸ¤– Ã‰valuation Automatique
          
          ${feedbackContent.substring(0, 2000)}...
          
          ğŸ“„ **Voir le fichier FEEDBACK.md complet pour tous les dÃ©tails**
          
          ---
          *Ã‰valuation gÃ©nÃ©rÃ©e automatiquement par GitHub Actions*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: ğŸ“Š Summary
      if: always()
      run: |
        echo "## ğŸ“‹ RÃ©sumÃ© de l'Ã‰valuation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **CompÃ©tence Ã©valuÃ©e:** ${{ steps.config.outputs.competence }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Niveau:** ${{ steps.config.outputs.niveau }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Fichiers analysÃ©s:** ${{ steps.config.outputs.files_to_analyze }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "FEEDBACK.md" ]; then
          echo "âœ… **Status:** Ã‰valuation terminÃ©e avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ **Feedback:** Disponible dans le fichier FEEDBACK.md" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status:** Erreur lors de l'Ã©valuation" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”§ **Action:** VÃ©rifier la configuration et les logs" >> $GITHUB_STEP_SUMMARY
        fi
